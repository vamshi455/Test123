CREATE OR REPLACE VIEW RMDE_SAM_ACC.COMPLETION_PVT_INTERPOLATED
AS
WITH PVTwithEndDate AS (
    SELECT
        ID_COMPLETION,
        TEST_DATE,
        PRESSURE,
        OIL_FORMATION_VOLUME_FACTOR,
        GAS_FORMATION_VOLUME_FACTOR,
        WATER_FORMATION_VOLUME_FACTOR,
        SOLUTION_GAS_OIL_RATIO,
        VOLATIZED_OIL_GAS_RATIO,
        VISCOSITY_OIL,
        VISCOSITY_WATER,
        VISCOSITY_GAS,
        INJECTED_GAS_FORMATION_VOLUME_FACTOR,
        INJECTED_WATER_FORMATION_VOLUME_FACTOR,
        COALESCE(
            (SELECT MIN(TEST_DATE)
             FROM RMDE_SAM_ACC.COMPLETION_PVT_CHARACTERISTICS cpvt
             WHERE cpvt.TEST_DATE > cpc.TEST_DATE
               AND cpvt.ID_COMPLETION = cpc.ID_COMPLETION),
            '9999-12-31'::DATE
        ) AS END_DATE
    FROM RMDE_SAM_ACC.COMPLETION_PVT_CHARACTERISTICS cpc
),
-- Combine pressure inputs from PATTERN_PRESSURE
PressureInputs AS (
    SELECT DISTINCT
        pp.ID_PATTERN,
        pp.DATE AS VRR_DATE,
        pp.PRESSURE,
        dv.COMPLETION_ID AS ID_COMPLETION
    FROM RMDE_SAM_ACC.PATTERN_PRESSURE pp
    INNER JOIN TRUSTED_DB.PRODUCTION_VOLUME.PRODUCTION_VOLUMES_DAILY_OILFIELD dv
        ON pp.ID_PATTERN = dv.ID_PATTERN
),
-- Find exact matches
ExactMatch AS (
    SELECT
        pi.ID_COMPLETION,
        pi.VRR_DATE,
        pi.PRESSURE,
        pvt.OIL_FORMATION_VOLUME_FACTOR,
        pvt.GAS_FORMATION_VOLUME_FACTOR,
        pvt.WATER_FORMATION_VOLUME_FACTOR,
        pvt.SOLUTION_GAS_OIL_RATIO,
        pvt.VOLATIZED_OIL_GAS_RATIO,
        pvt.VISCOSITY_OIL,
        pvt.VISCOSITY_WATER,
        pvt.VISCOSITY_GAS,
        pvt.INJECTED_GAS_FORMATION_VOLUME_FACTOR,
        pvt.INJECTED_WATER_FORMATION_VOLUME_FACTOR
    FROM PressureInputs pi
    INNER JOIN PVTwithEndDate pvt
        ON pvt.ID_COMPLETION = pi.ID_COMPLETION
        AND pvt.PRESSURE = pi.PRESSURE
        AND pvt.TEST_DATE = (
            SELECT MAX(p.TEST_DATE)
            FROM PVTwithEndDate p
            WHERE p.ID_COMPLETION = pi.ID_COMPLETION
              AND p.PRESSURE = pi.PRESSURE
              AND p.TEST_DATE <= LAST_DAY(pi.VRR_DATE)
        )
),
-- Find lower bounds
LowerBound AS (
    SELECT
        pi.ID_COMPLETION,
        pi.VRR_DATE,
        pi.PRESSURE AS TARGET_PRESSURE,
        pvt.PRESSURE,
        pvt.OIL_FORMATION_VOLUME_FACTOR,
        pvt.GAS_FORMATION_VOLUME_FACTOR,
        pvt.WATER_FORMATION_VOLUME_FACTOR,
        pvt.SOLUTION_GAS_OIL_RATIO,
        pvt.VOLATIZED_OIL_GAS_RATIO,
        pvt.VISCOSITY_OIL,
        pvt.VISCOSITY_WATER,
        pvt.VISCOSITY_GAS,
        pvt.INJECTED_GAS_FORMATION_VOLUME_FACTOR,
        pvt.INJECTED_WATER_FORMATION_VOLUME_FACTOR
    FROM PressureInputs pi
    INNER JOIN PVTwithEndDate pvt
        ON pvt.ID_COMPLETION = pi.ID_COMPLETION
        AND pvt.PRESSURE < pi.PRESSURE
        AND pvt.TEST_DATE <= LAST_DAY(pi.VRR_DATE)
    QUALIFY ROW_NUMBER() OVER (
        PARTITION BY pi.ID_COMPLETION, pi.VRR_DATE, pi.PRESSURE
        ORDER BY pvt.PRESSURE DESC, pvt.TEST_DATE DESC
    ) = 1
),
-- Find upper bounds
UpperBound AS (
    SELECT
        pi.ID_COMPLETION,
        pi.VRR_DATE,
        pi.PRESSURE AS TARGET_PRESSURE,
        pvt.PRESSURE,
        pvt.OIL_FORMATION_VOLUME_FACTOR,
        pvt.GAS_FORMATION_VOLUME_FACTOR,
        pvt.WATER_FORMATION_VOLUME_FACTOR,
        pvt.SOLUTION_GAS_OIL_RATIO,
        pvt.VOLATIZED_OIL_GAS_RATIO,
        pvt.VISCOSITY_OIL,
        pvt.VISCOSITY_WATER,
        pvt.VISCOSITY_GAS,
        pvt.INJECTED_GAS_FORMATION_VOLUME_FACTOR,
        pvt.INJECTED_WATER_FORMATION_VOLUME_FACTOR
    FROM PressureInputs pi
    INNER JOIN PVTwithEndDate pvt
        ON pvt.ID_COMPLETION = pi.ID_COMPLETION
        AND pvt.PRESSURE > pi.PRESSURE
        AND pvt.TEST_DATE <= LAST_DAY(pi.VRR_DATE)
    QUALIFY ROW_NUMBER() OVER (
        PARTITION BY pi.ID_COMPLETION, pi.VRR_DATE, pi.PRESSURE
        ORDER BY pvt.PRESSURE ASC, pvt.TEST_DATE DESC
    ) = 1
),
-- Find second bounds for extrapolation
SecondBound AS (
    SELECT
        pi.ID_COMPLETION,
        pi.VRR_DATE,
        pi.PRESSURE AS TARGET_PRESSURE,
        pvt.PRESSURE,
        pvt.OIL_FORMATION_VOLUME_FACTOR,
        pvt.GAS_FORMATION_VOLUME_FACTOR,
        pvt.WATER_FORMATION_VOLUME_FACTOR,
        pvt.SOLUTION_GAS_OIL_RATIO,
        pvt.VOLATIZED_OIL_GAS_RATIO,
        pvt.VISCOSITY_OIL,
        pvt.VISCOSITY_WATER,
        pvt.VISCOSITY_GAS,
        pvt.INJECTED_GAS_FORMATION_VOLUME_FACTOR,
        pvt.INJECTED_WATER_FORMATION_VOLUME_FACTOR
    FROM PressureInputs pi
    INNER JOIN PVTwithEndDate pvt
        ON pvt.ID_COMPLETION = pi.ID_COMPLETION
        AND pvt.TEST_DATE <= LAST_DAY(pi.VRR_DATE)
    INNER JOIN UpperBound ub
        ON ub.ID_COMPLETION = pi.ID_COMPLETION
        AND ub.VRR_DATE = pi.VRR_DATE
        AND ub.TARGET_PRESSURE = pi.PRESSURE
        AND pvt.PRESSURE > ub.PRESSURE
    QUALIFY ROW_NUMBER() OVER (
        PARTITION BY pi.ID_COMPLETION, pi.VRR_DATE, pi.PRESSURE
        ORDER BY pvt.PRESSURE ASC, pvt.TEST_DATE DESC
    ) = 1
),
-- Interpolated and extrapolated values
InterpolatedValues AS (
    -- Exact match
    SELECT
        ID_COMPLETION,
        VRR_DATE,
        PRESSURE,
        OIL_FORMATION_VOLUME_FACTOR,
        GAS_FORMATION_VOLUME_FACTOR,
        WATER_FORMATION_VOLUME_FACTOR,
        SOLUTION_GAS_OIL_RATIO,
        VOLATIZED_OIL_GAS_RATIO,
        VISCOSITY_OIL,
        VISCOSITY_WATER,
        VISCOSITY_GAS,
        INJECTED_GAS_FORMATION_VOLUME_FACTOR,
        INJECTED_WATER_FORMATION_VOLUME_FACTOR
    FROM ExactMatch

    UNION ALL

    -- Interpolation between lower and upper bounds
    SELECT
        lb.ID_COMPLETION,
        lb.VRR_DATE,
        lb.TARGET_PRESSURE AS PRESSURE,
        lb.OIL_FORMATION_VOLUME_FACTOR + 
            (ub.OIL_FORMATION_VOLUME_FACTOR - lb.OIL_FORMATION_VOLUME_FACTOR) * 
            (lb.TARGET_PRESSURE - lb.PRESSURE) / (ub.PRESSURE - lb.PRESSURE) AS OIL_FORMATION_VOLUME_FACTOR,
        lb.GAS_FORMATION_VOLUME_FACTOR + 
            (ub.GAS_FORMATION_VOLUME_FACTOR - lb.GAS_FORMATION_VOLUME_FACTOR) * 
            (lb.TARGET_PRESSURE - lb.PRESSURE) / (ub.PRESSURE - lb.PRESSURE) AS GAS_FORMATION_VOLUME_FACTOR,
        lb.WATER_FORMATION_VOLUME_FACTOR + 
            (ub.WATER_FORMATION_VOLUME_FACTOR - lb.WATER_FORMATION_VOLUME_FACTOR) * 
            (lb.TARGET_PRESSURE - lb.PRESSURE) / (ub.PRESSURE - lb.PRESSURE) AS WATER_FORMATION_VOLUME_FACTOR,
        lb.SOLUTION_GAS_OIL_RATIO + 
            (ub.SOLUTION_GAS_OIL_RATIO - lb.SOLUTION_GAS_OIL_RATIO) * 
            (lb.TARGET_PRESSURE - lb.PRESSURE) / (ub.PRESSURE - lb.PRESSURE) AS SOLUTION_GAS_OIL_RATIO,
        lb.VOLATIZED_OIL_GAS_RATIO + 
            (ub.VOLATIZED_OIL_GAS_RATIO - lb.VOLATIZED_OIL_GAS_RATIO) * 
            (lb.TARGET_PRESSURE - lb.PRESSURE) / (ub.PRESSURE - lb.PRESSURE) AS VOLATIZED_OIL_GAS_RATIO,
        lb.VISCOSITY_OIL + 
            (ub.VISCOSITY_OIL - lb.VISCOSITY_OIL) * 
            (lb.TARGET_PRESSURE - lb.PRESSURE) / (ub.PRESSURE - lb.PRESSURE) AS VISCOSITY_OIL,
        lb.VISCOSITY_WATER + 
            (ub.VISCOSITY_WATER - lb.VISCOSITY_WATER) * 
            (lb.TARGET_PRESSURE - lb.PRESSURE) / (ub.PRESSURE - lb.PRESSURE) AS VISCOSITY_WATER,
        lb.VISCOSITY_GAS + 
            (ub.VISCOSITY_GAS - lb.VISCOSITY_GAS) * 
            (lb.TARGET_PRESSURE - lb.PRESSURE) / (ub.PRESSURE - lb.PRESSURE) AS VISCOSITY_GAS,
        lb.INJECTED_GAS_FORMATION_VOLUME_FACTOR + 
            (ub.INJECTED_GAS_FORMATION_VOLUME_FACTOR - lb.INJECTED_GAS_FORMATION_VOLUME_FACTOR) * 
            (lb.TARGET_PRESSURE - lb.PRESSURE) / (ub.PRESSURE - lb.PRESSURE) AS INJECTED_GAS_FORMATION_VOLUME_FACTOR,
        lb.INJECTED_WATER_FORMATION_VOLUME_FACTOR + 
            (ub.INJECTED_WATER_FORMATION_VOLUME_FACTOR - lb.INJECTED_WATER_FORMATION_VOLUME_FACTOR) * 
            (lb.TARGET_PRESSURE - lb.PRESSURE) / (ub.PRESSURE - lb.PRESSURE) AS INJECTED_WATER_FORMATION_VOLUME_FACTOR
    FROM LowerBound lb
    INNER JOIN UpperBound ub
        ON lb.ID_COMPLETION = ub.ID_COMPLETION
        AND lb.VRR_DATE = ub.VRR_DATE
        AND lb.TARGET_PRESSURE = ub.TARGET_PRESSURE
    WHERE NOT EXISTS (
        SELECT 1 FROM ExactMatch em
        WHERE em.ID_COMPLETION = lb.ID_COMPLETION
          AND em.VRR_DATE = lb.VRR_DATE
          AND em.PRESSURE = lb.TARGET_PRESSURE
    )

    UNION ALL

    -- Extrapolation using upper and second bounds
    SELECT
        ub.ID_COMPLETION,
        ub.VRR_DATE,
        ub.TARGET_PRESSURE AS PRESSURE,
        ub.OIL_FORMATION_VOLUME_FACTOR + 
            (sb.OIL_FORMATION_VOLUME_FACTOR - ub.OIL_FORMATION_VOLUME_FACTOR) * 
            (ub.TARGET_PRESSURE - ub.PRESSURE) / (sb.PRESSURE - ub.PRESSURE) AS OIL_FORMATION_VOLUME_FACTOR,
        ub.GAS_FORMATION_VOLUME_FACTOR + 
            (sb.GAS_FORMATION_VOLUME_FACTOR - ub.GAS_FORMATION_VOLUME_FACTOR) * 
            (ub.TARGET_PRESSURE - ub.PRESSURE) / (sb.PRESSURE - ub.PRESSURE) AS GAS_FORMATION_VOLUME_FACTOR,
        ub.WATER_FORMATION_VOLUME_FACTOR + 
            (sb.WATER_FORMATION_VOLUME_FACTOR - ub.WATER_FORMATION_VOLUME_FACTOR) * 
            (ub.TARGET_PRESSURE - ub.PRESSURE) / (sb.PRESSURE - ub.PRESSURE) AS WATER_FORMATION_VOLUME_FACTOR,
        ub.SOLUTION_GAS_OIL_RATIO + 
            (sb.SOLUTION_GAS_OIL_RATIO - ub.SOLUTION_GAS_OIL_RATIO) * 
            (ub.TARGET_PRESSURE - ub.PRESSURE) / (sb.PRESSURE - ub.PRESSURE) AS SOLUTION_GAS_OIL_RATIO,
        ub.VOLATIZED_OIL_GAS_RATIO + 
            (sb.VOLATIZED_OIL_GAS_RATIO - ub.VOLATIZED_OIL_GAS_RATIO) * 
            (ub.TARGET_PRESSURE - ub.PRESSURE) / (sb.PRESSURE - ub.PRESSURE) AS VOLATIZED_OIL_GAS_RATIO,
        ub.VISCOSITY_OIL + 
            (sb.VISCOSITY_OIL - ub.VISCOSITY_OIL) * 
            (ub.TARGET_PRESSURE - ub.PRESSURE) / (sb.PRESSURE - ub.PRESSURE) AS VISCOSITY_OIL,
        ub.VISCOSITY_WATER + 
            (sb.VISCOSITY_WATER - ub.VISCOSITY_WATER) * 
            (ub.TARGET_PRESSURE - ub.PRESSURE) / (sb.PRESSURE - ub.PRESSURE) AS VISCOSITY_WATER,
        ub.VISCOSITY_GAS + 
            (sb.VISCOSITY_GAS - ub.VISCOSITY_GAS) * 
            (ub.TARGET_PRESSURE - ub.PRESSURE) / (sb.PRESSURE - ub.PRESSURE) AS VISCOSITY_GAS,
        ub.INJECTED_GAS_FORMATION_VOLUME_FACTOR + 
            (sb.INJECTED_GAS_FORMATION_VOLUME_FACTOR - ub.INJECTED_GAS_FORMATION_VOLUME_FACTOR) * 
            (ub.TARGET_PRESSURE - ub.PRESSURE) / (sb.PRESSURE - ub.PRESSURE) AS INJECTED_GAS_FORMATION_VOLUME_FACTOR,
        ub.INJECTED_WATER_FORMATION_VOLUME_FACTOR + 
            (sb.INJECTED_WATER_FORMATION_VOLUME_FACTOR - ub.INJECTED_WATER_FORMATION_VOLUME_FACTOR) * 
            (ub.TARGET_PRESSURE - ub.PRESSURE) / (sb.PRESSURE - ub.PRESSURE) AS INJECTED_WATER_FORMATION_VOLUME_FACTOR
    FROM UpperBound ub
    INNER JOIN SecondBound sb
        ON ub.ID_COMPLETION = sb.ID_COMPLETION
        AND ub.VRR_DATE = sb.VRR_DATE
        AND ub.TARGET_PRESSURE = sb.TARGET_PRESSURE
    WHERE NOT EXISTS (
        SELECT 1 FROM ExactMatch em
        WHERE em.ID_COMPLETION = ub.ID_COMPLETION
          AND em.VRR_DATE = ub.VRR_DATE
          AND em.PRESSURE = ub.TARGET_PRESSURE
    )
    AND NOT EXISTS (
        SELECT 1 FROM LowerBound lb
        WHERE lb.ID_COMPLETION = ub.ID_COMPLETION
          AND lb.VRR_DATE = ub.VRR_DATE
          AND lb.TARGET_PRESSURE = ub.TARGET_PRESSURE
    )
    AND (
        SELECT COUNT(*)
        FROM PVTwithEndDate p
        WHERE p.ID_COMPLETION = ub.ID_COMPLETION
          AND p.PRESSURE > ub.TARGET_PRESSURE
          AND p.TEST_DATE <= LAST_DAY(ub.VRR_DATE)
    ) > 1

    UNION ALL

    -- No valid data
    SELECT
        pi.ID_COMPLETION,
        pi.VRR_DATE,
        pi.PRESSURE,
        NULL AS OIL_FORMATION_VOLUME_FACTOR,
        NULL AS GAS_FORMATION_VOLUME_FACTOR,
        NULL AS WATER_FORMATION_VOLUME_FACTOR,
        NULL AS SOLUTION_GAS_OIL_RATIO,
        NULL AS VOLATIZED_OIL_GAS_RATIO,
        NULL AS VISCOSITY_OIL,
        NULL AS VISCOSITY_WATER,
        NULL AS VISCOSITY_GAS,
        NULL AS INJECTED_GAS_FORMATION_VOLUME_FACTOR,
        NULL AS INJECTED_WATER_FORMATION_VOLUME_FACTOR
    FROM PressureInputs pi
    WHERE NOT EXISTS (
        SELECT 1 FROM ExactMatch em
        WHERE em.ID_COMPLETION = pi.ID_COMPLETION
          AND em.VRR_DATE = pi.VRR_DATE
          AND em.PRESSURE = pi.PRESSURE
    )
    AND NOT EXISTS (
        SELECT 1 FROM LowerBound lb
        WHERE lb.ID_COMPLETION = pi.ID_COMPLETION
          AND lb.VRR_DATE = pi.VRR_DATE
          AND lb.TARGET_PRESSURE = pi.PRESSURE
    )
    AND NOT EXISTS (
        SELECT 1 FROM UpperBound ub
        WHERE ub.ID_COMPLETION = pi.ID_COMPLETION
          AND ub.VRR_DATE = pi.VRR_DATE
          AND ub.TARGET_PRESSURE = pi.PRESSURE
    )
)
SELECT
    ID_COMPLETION,
    VRR_DATE,
    ROUND(PRESSURE, 5) AS PRESSURE,
    ROUND(OIL_FORMATION_VOLUME_FACTOR, 5) AS OIL_FORMATION_VOLUME_FACTOR,
    ROUND(GAS_FORMATION_VOLUME_FACTOR, 5) AS GAS_FORMATION_VOLUME_FACTOR,
    ROUND(WATER_FORMATION_VOLUME_FACTOR, 5) AS WATER_FORMATION_VOLUME_FACTOR,
    ROUND(SOLUTION_GAS_OIL_RATIO, 5) AS SOLUTION_GAS_OIL_RATIO,
    ROUND(VOLATIZED_OIL_GAS_RATIO, 5) AS VOLATIZED_OIL_GAS_RATIO,
    ROUND(VISCOSITY_OIL, 5) AS VISCOSITY_OIL,
    ROUND(VISCOSITY_WATER, 5) AS VISCOSITY_WATER,
    ROUND(VISCOSITY_GAS, 5) AS VISCOSITY_GAS,
    ROUND(INJECTED_GAS_FORMATION_VOLUME_FACTOR, 5) AS INJECTED_GAS_FORMATION_VOLUME_FACTOR,
    ROUND(INJECTED_WATER_FORMATION_VOLUME_FACTOR, 5) AS INJECTED_WATER_FORMATION_VOLUME_FACTOR
FROM InterpolatedValues;
